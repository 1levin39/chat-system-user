<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥½å‹èŠå¤© - {{ nickname }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background-color: #f5f5f5;
        }
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background-color: #007bff;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .navbar h2 {
            font-size: 20px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-nickname {
            font-weight: bold;
        }
        .logout-btn {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            background-color: #0056b3;
        }
        .logout-btn:hover {
            background-color: #003d82;
        }

        /* èŠå¤©ä¸»å®¹å™¨ */
        .chat-container {
            display: flex;
            width: 100%;
            height: calc(100vh - 60px);
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        /* å·¦ä¾§å¥½å‹åˆ—è¡¨åŒº */
        .friend-list-panel {
            width: 300px;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }
        .search-bar {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }
        .search-input:focus {
            border-color: #007bff;
        }
        .search-result {
            max-height: 200px;
            overflow-y: auto;
            padding: 0 15px;
            display: none;
        }
        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-result-item:hover {
            background-color: #fafafa;
        }
        .add-friend-btn {
            padding: 5px 10px;
            font-size: 12px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .add-friend-btn:hover {
            background-color: #218838;
        }
        .friend-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        .friend-item {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .friend-item:hover {
            background-color: #f5f5f5;
        }
        .friend-item.active {
            background-color: #e9f5ff;
            border-left: 3px solid #007bff;
        }
        .friend-info {
            display: flex;
            flex-direction: column;
        }
        .friend-nickname {
            font-size: 16px;
            color: #333;
        }
        .friend-status {
            font-size: 12px;
            margin-top: 3px;
        }
        .status-online {
            color: #28a745;
        }
        .status-offline {
            color: #6c757d;
        }
        .no-friends {
            text-align: center;
            padding: 50px 0;
            color: #666;
            font-size: 14px;
        }

        /* å³ä¾§èŠå¤©çª—å£åŒº */
        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            display: none;
        }
        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        .chat-header h3 {
            font-size: 18px;
            color: #333;
        }
        .chat-header .friend-status {
            margin-left: 10px;
        }
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #fafafa;
        }
        .message {
            margin-bottom: 15px;
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 8px;
            line-height: 1.5;
            position: relative;
        }
        .message-sent {
            background-color: #007bff;
            color: white;
            margin-left: auto;
        }
        .message-received {
            background-color: white;
            color: #333;
            border: 1px solid #eee;
            margin-right: auto;
        }
        .message-content {
            font-size: 15px;
        }
        .message-emoji {
            font-size: 24px;
        }
        .message-meta {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.8;
            text-align: right;
        }
        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .emoji-trigger {
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .emoji-panel {
            position: absolute;
            bottom: 80px;
            left: 20px;
            background-color: white;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
            display: none;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            z-index: 100;
        }
        .emoji-item {
            font-size: 24px;
            cursor: pointer;
            text-align: center;
            padding: 5px;
        }
        .emoji-item:hover {
            background-color: #f5f5f5;
            border-radius: 3px;
        }
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 15px;
            resize: none;
            outline: none;
            height: 50px;
            max-height: 150px;
        }
        .message-input:focus {
            border-color: #007bff;
        }
        .send-btn {
            padding: 12px 25px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            cursor: pointer;
        }
        .send-btn:hover {
            background-color: #0056b3;
        }

        /* æç¤ºæ¡† */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 5px;
            color: white;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }
        .toast-success {
            background-color: #28a745;
        }
        .toast-error {
            background-color: #dc3545;
        }
        .toast-info {
            background-color: #17a2b8;
        }

        /* ç©ºèŠå¤©çª—å£æç¤º */
        .empty-chat-tip {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #666;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="navbar">
        <h2>èŠå¤©äº¤å‹ç³»ç»Ÿ</h2>
        <div class="user-info">
            <span class="user-nickname">å½“å‰ç”¨æˆ·: {{ nickname }}</span>
            <a href="/logout" class="logout-btn">é€€å‡ºç™»å½•</a>
        </div>
    </div>

    <!-- èŠå¤©ä¸»å®¹å™¨ -->
    <div class="chat-container">
        <!-- å·¦ä¾§å¥½å‹åˆ—è¡¨åŒº -->
        <div class="friend-list-panel">
            <div class="search-bar">
                <label for="friend-search-input" style="display:none;">æœç´¢å¥½å‹æ˜µç§°</label>
                <input type="text" class="search-input" placeholder="æœç´¢å¥½å‹æ˜µç§°..." id="friend-search-input">
                <div class="search-result" id="search-result-panel"></div>
            </div>
            <div class="friend-list" id="friend-list-container">
                {% if friends|length == 0 %}
                    <div class="no-friends">æš‚æ— å¥½å‹ï¼Œæœç´¢æ·»åŠ å§ï½</div>
                {% else %}
                    {% for friend in friends %}
                        <div class="friend-item" data-friend-id="{{ friend.friend_id }}" data-friend-nickname="{{ friend.friend_nickname }}">
                            <div class="friend-info">
                                <div class="friend-nickname">{{ friend.friend_nickname }}</div>
                                <div class="friend-status {% if friend.status == 'online' %}status-online{% else %}status-offline{% endif %}">
                                    {% if friend.status == 'online' %}åœ¨çº¿{% else %}ç¦»çº¿{% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <!-- å³ä¾§èŠå¤©çª—å£åŒº -->
        <div class="chat-window" id="chat-window">
            <div class="chat-header" id="chat-header">
                <h3 id="current-friend-nickname"></h3>
                <div class="friend-status" id="current-friend-status"></div>
            </div>
            <div class="chat-messages" id="chat-messages-container">
                <!-- ç©ºèŠå¤©æç¤º -->
                <div class="empty-chat-tip" id="empty-chat-tip">é€‰æ‹©å¥½å‹å¼€å§‹èŠå¤©å§ï½</div>
                <!-- èŠå¤©è®°å½•å°†åŠ¨æ€æ¸²æŸ“ -->
            </div>
            <!-- è¡¨æƒ…é¢æ¿ -->
            <div class="emoji-panel" id="emoji-panel">
                <div class="emoji-item" data-emoji="emoji_1">ğŸ˜Š</div>
                <div class="emoji-item" data-emoji="emoji_2">ğŸ˜‚</div>
                <div class="emoji-item" data-emoji="emoji_3">â¤ï¸</div>
                <div class="emoji-item" data-emoji="emoji_4">ğŸ‘</div>
                <div class="emoji-item" data-emoji="emoji_5">ğŸ‰</div>
                <div class="emoji-item" data-emoji="emoji_6">ğŸ˜¢</div>
                <div class="emoji-item" data-emoji="emoji_7">ğŸ˜ </div>
                <div class="emoji-item" data-emoji="emoji_8">ğŸ¤”</div>
                <div class="emoji-item" data-emoji="emoji_9">ğŸ‘</div>
                <div class="emoji-item" data-emoji="emoji_10">ğŸŒŸ</div>
            </div>
            <div class="chat-input-area">
                <div class="emoji-trigger" id="emoji-trigger">ğŸ˜€</div>
                <label for="message-input" style="display: none;">è¾“å…¥æ¶ˆæ¯</label>
                <textarea class="message-input" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ˆä¸è¶…è¿‡200å­—ç¬¦ï¼‰" maxlength="200"></textarea>
                <button class="send-btn" id="send-message-btn">å‘é€</button>
            </div>
        </div>
    </div>

    <!-- æç¤ºæ¡† -->
    <div class="toast" id="toast"></div>

    <!-- SocketIOå®¢æˆ·ç«¯åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        const user_id = {{ user_id }};
        const user_nickname = "{{ nickname }}";
        let current_friend_id = null;
        let current_friend_nickname = null;
        const emojiMap = {
            'emoji_1': 'ğŸ˜Š', 'emoji_2': 'ğŸ˜‚', 'emoji_3': 'â¤ï¸', 'emoji_4': 'ğŸ‘', 'emoji_5': 'ğŸ‰',
            'emoji_6': 'ğŸ˜¢', 'emoji_7': 'ğŸ˜ ', 'emoji_8': 'ğŸ¤”', 'emoji_9': 'ğŸ‘', 'emoji_10': 'ğŸŒŸ'
        };

        // DOMå…ƒç´ 
        const socket = io.connect(`http://${document.domain}:${location.port}`);
        const friendListContainer = document.getElementById('friend-list-container');
        const chatWindow = document.getElementById('chat-window');
        const chatHeader = document.getElementById('chat-header');
        const currentFriendNicknameEl = document.getElementById('current-friend-nickname');
        const currentFriendStatusEl = document.getElementById('current-friend-status');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const emptyChatTip = document.getElementById('empty-chat-tip');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const emojiTrigger = document.getElementById('emoji-trigger');
        const emojiPanel = document.getElementById('emoji-panel');
        const toast = document.getElementById('toast');
        const friendSearchInput = document.getElementById('friend-search-input');
        const searchResultPanel = document.getElementById('search-result-panel');

        // ---------------------- åˆå§‹åŒ– ----------------------
        window.onload = function() {
            // 30ç§’åˆ·æ–°ä¸€æ¬¡å¥½å‹çŠ¶æ€
            setInterval(refreshFriendStatus, 30000);
            // åˆå§‹åˆ·æ–°ä¸€æ¬¡
            refreshFriendStatus();

            // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
            initSearchFunction();
        };

        // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
        function initSearchFunction() {
            friendSearchInput.addEventListener('input', function(e) {
                const keyword = e.target.value.trim();
                if (keyword.length < 2) {
                    searchResultPanel.style.display = 'none';
                    return;
                }

                socket.emit('search_friend', keyword);
            });

            // æœç´¢ç»“æœç‚¹å‡»äº‹ä»¶å§”æ‰˜
            searchResultPanel.addEventListener('click', function(e) {
                const addBtn = e.target.closest('.add-friend-btn');
                if (addBtn) {
                    const friendId = parseInt(addBtn.dataset.friendId);
                    socket.emit('add_friend', friendId);
                }
            });
        }

        // ---------------------- æç¤ºæ¡†å·¥å…·å‡½æ•° ----------------------
        function showToast(msg, type = 'info') {
            toast.textContent = msg;
            toast.className = `toast toast-${type}`;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // ---------------------- å¥½å‹åˆ—è¡¨ç›¸å…³ ----------------------
        // é€‰æ‹©å¥½å‹å¼€å§‹èŠå¤©
        friendListContainer.addEventListener('click', function(e) {
            const friendItem = e.target.closest('.friend-item');
            if (!friendItem) return;

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.friend-item').forEach(item => {
                item.classList.remove('active');
            });
            friendItem.classList.add('active');

            // è®¾ç½®å½“å‰èŠå¤©å¥½å‹
            current_friend_id = parseInt(friendItem.dataset.friend_id);
            current_friend_nickname = friendItem.dataset.friend_nickname;

            // æ›´æ–°èŠå¤©çª—å£æ ‡é¢˜
            currentFriendNicknameEl.textContent = current_friend_nickname;
            const statusText = friendItem.querySelector('.friend-status').textContent;
            currentFriendStatusEl.textContent = `(${statusText})`;
            currentFriendStatusEl.className = `friend-status ${statusText === 'åœ¨çº¿' ? 'status-online' : 'status-offline'}`;

            // æ˜¾ç¤ºèŠå¤©çª—å£
            chatWindow.style.display = 'flex';
            // åŠ è½½èŠå¤©å†å²è®°å½•
            loadChatHistory();
        });

        // åˆ·æ–°å¥½å‹çŠ¶æ€
        function refreshFriendStatus() {
            socket.emit('refresh_friend_status');
        }

        // æ¥æ”¶å¥½å‹çŠ¶æ€åˆ·æ–°ç»“æœ
        socket.on('friend_status_list', function(data) {
            if (data.msg !== 'çŠ¶æ€åˆ·æ–°æˆåŠŸ') {
                showToast(data.msg, 'error');
                return;
            }

            const friends = data.friends;
            // æ›´æ–°å¥½å‹åˆ—è¡¨çŠ¶æ€
            friends.forEach(friend => {
                const friendItem = document.querySelector(`.friend-item[data-friend-id="${friend.friend_id}"]`);
                if (friendItem) {
                    const statusEl = friendItem.querySelector('.friend-status');
                    statusEl.textContent = friend.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿';
                    statusEl.className = `friend-status ${friend.status === 'online' ? 'status-online' : 'status-offline'}`;

                    // å¦‚æœå½“å‰èŠå¤©çš„æ˜¯è¯¥å¥½å‹ï¼Œæ›´æ–°èŠå¤©çª—å£çŠ¶æ€
                    if (current_friend_id === friend.friend_id) {
                        currentFriendStatusEl.textContent = `(${friend.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'})`;
                        currentFriendStatusEl.className = `friend-status ${friend.status === 'online' ? 'status-online' : 'status-offline'}`;
                    }
                }
            });
        });

        // æ¥æ”¶å¥½å‹çŠ¶æ€å˜åŒ–é€šçŸ¥ï¼ˆå®æ—¶ï¼‰
        socket.on('friend_status_change', function(data) {
            const friendItem = document.querySelector(`.friend-item[data-friend-id="${data.user_id}"]`);
            if (friendItem) {
                const statusEl = friendItem.querySelector('.friend-status');
                statusEl.textContent = data.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿';
                statusEl.className = `friend-status ${data.status === 'online' ? 'status-online' : 'status-offline'}`;

                // å¦‚æœå½“å‰èŠå¤©çš„æ˜¯è¯¥å¥½å‹ï¼Œæ›´æ–°èŠå¤©çª—å£çŠ¶æ€
                if (current_friend_id === data.user_id) {
                    currentFriendStatusEl.textContent = `(${data.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'})`;
                    currentFriendStatusEl.className = `friend-status ${data.status === 'online' ? 'status-online' : 'status-offline'}`;
                }
            }
        });

        // æ¥æ”¶æœç´¢ç»“æœ
        socket.on('search_result', function(data) {
            if (data.count === 0) {
                searchResultPanel.style.display = 'none';
                return;
            }

            let html = '';
            data.friends.forEach(friend => {
                html += `
                    <div class="search-result-item">
                        <div>
                            <div>${friend.friend_nickname}</div>
                            <div style="font-size:12px;color:#666;">
                                ${friend.tag1 ? '#'+friend.tag1 : ''}
                                ${friend.tag2 ? '#'+friend.tag2 : ''}
                                ${friend.tag3 ? '#'+friend.tag3 : ''}
                            </div>
                        </div>
                        <button class="add-friend-btn" data-friend-id="${friend.friend_id}">æ·»åŠ </button>
                    </div>
                `;
            });
            searchResultPanel.innerHTML = html;
            searchResultPanel.style.display = 'block';
        });

        // æ¥æ”¶æ·»åŠ å¥½å‹ç»“æœ
        socket.on('add_friend_success', function(data) {
            showToast(data.msg, 'success');
            searchResultPanel.style.display = 'none';
            friendSearchInput.value = '';
            // åˆ·æ–°å¥½å‹åˆ—è¡¨
            loadFriendList();
        });

        socket.on('add_friend_error', function(data) {
            showToast(data.msg, 'error');
        });

        // æ¥æ”¶æ–°å¥½å‹é€šçŸ¥
        socket.on('new_friend_notify', function(data) {
            showToast(`æ–°å¥½å‹ï¼š${data.friend_nickname}`, 'success');
            // åˆ·æ–°å¥½å‹åˆ—è¡¨
            refreshFriendStatus();
            loadFriendList();
        });

        // é‡æ–°åŠ è½½å¥½å‹åˆ—è¡¨
        function loadFriendList() {
            fetch('/chat')
                .then(response => response.text())
                .then(html => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    const newFriendList = tempDiv.querySelector('#friend-list-container').innerHTML;
                    friendListContainer.innerHTML = newFriendList;
                })
                .catch(error => {
                    showToast('å¥½å‹åˆ—è¡¨åŠ è½½å¤±è´¥', 'error');
                });
        }

        // ---------------------- èŠå¤©ç›¸å…³ ----------------------
        // åŠ è½½èŠå¤©å†å²è®°å½•
        function loadChatHistory() {
            if (!current_friend_id) return;

            // æ˜¾ç¤ºåŠ è½½ä¸­
            emptyChatTip.textContent = 'åŠ è½½èŠå¤©è®°å½•ä¸­...';
            emptyChatTip.style.display = 'flex';

            socket.emit('get_chat_history', { friend_id: current_friend_id });
        }

        // æ¥æ”¶èŠå¤©å†å²è®°å½•
        socket.on('chat_history', function(data) {
            const history = data.history;
            chatMessagesContainer.innerHTML = '';

            if (history.length === 0) {
                emptyChatTip.textContent = 'æš‚æ— èŠå¤©è®°å½•ï¼Œå¼€å§‹èŠå¤©å§ï½';
                emptyChatTip.style.display = 'flex';
                return;
            }

            // éšè—ç©ºæç¤º
            emptyChatTip.style.display = 'none';

            // æ¸²æŸ“æ¯æ¡æ¶ˆæ¯
            history.forEach(msg => {
                renderMessage(msg);
            });

            // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
            scrollToBottom();

            // æ ‡è®°æœªè¯»æ¶ˆæ¯ä¸ºå·²è¯»
            history.forEach(msg => {
                if (msg.receiver_id === user_id && msg.is_read === 0) {
                    socket.emit('mark_message_read', msg.message_id);
                }
            });
        });

        // æ¸²æŸ“å•æ¡æ¶ˆæ¯
        function renderMessage(msg) {
            const isSent = msg.sender_id === user_id;
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'message-sent' : 'message-received'}`;
            messageDiv.dataset.message_id = msg.message_id;

            // æ¶ˆæ¯å†…å®¹ï¼ˆæ–‡å­—/è¡¨æƒ…ï¼‰
            let contentHtml = '';
            if (msg.message_type === 'text') {
                contentHtml = `<div class="message-content">${msg.content}</div>`;
            } else if (msg.message_type === 'emoji') {
                contentHtml = `<div class="message-emoji">${emojiMap[msg.content] || msg.content}</div>`;
            }

            // æ¶ˆæ¯å…ƒæ•°æ®ï¼ˆæ—¶é—´+å·²è¯»çŠ¶æ€ï¼‰
            const readText = isSent ? (msg.is_read ? 'å·²è¯»' : 'æœªè¯»') : '';
            const metaHtml = `<div class="message-meta">${msg.send_time} ${readText}</div>`;

            messageDiv.innerHTML = contentHtml + metaHtml;
            chatMessagesContainer.appendChild(messageDiv);
        }

        // å‘é€æ–‡å­—æ¶ˆæ¯
        function sendTextMessage() {
            const content = messageInput.value.trim();
            if (!content) {
                showToast('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            if (content.length > 200) {
                showToast('æ¶ˆæ¯ä¸èƒ½è¶…è¿‡200å­—ç¬¦', 'error');
                return;
            }
            if (!current_friend_id) {
                showToast('è¯·å…ˆé€‰æ‹©èŠå¤©å¥½å‹', 'error');
                return;
            }

            // å‘é€æ¶ˆæ¯
            socket.emit('send_message', {
                receiver_id: current_friend_id,
                content: content,
                message_type: 'text'
            });

            // æ¸…ç©ºè¾“å…¥æ¡†
            messageInput.value = '';
        }

        // å‘é€è¡¨æƒ…æ¶ˆæ¯
        function sendEmojiMessage(emojiCode) {
            if (!current_friend_id) {
                showToast('è¯·å…ˆé€‰æ‹©èŠå¤©å¥½å‹', 'error');
                return;
            }

            socket.emit('send_message', {
                receiver_id: current_friend_id,
                content: emojiCode,
                message_type: 'emoji'
            });
        }

        // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        sendMessageBtn.addEventListener('click', sendTextMessage);

        // è¾“å…¥æ¡†æŒ‰Enterå‘é€ï¼ˆShift+Enteræ¢è¡Œï¼‰
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendTextMessage();
            }
        });

        // è¡¨æƒ…é¢æ¿åˆ‡æ¢
        emojiTrigger.addEventListener('click', function() {
            emojiPanel.style.display = emojiPanel.style.display === 'block' ? 'none' : 'block';
        });

        // ç‚¹å‡»è¡¨æƒ…å‘é€
        emojiPanel.addEventListener('click', function(e) {
            const emojiItem = e.target.closest('.emoji-item');
            if (!emojiItem) return;

            const emojiCode = emojiItem.dataset.emoji;
            sendEmojiMessage(emojiCode);
            // éšè—è¡¨æƒ…é¢æ¿
            emojiPanel.style.display = 'none';
        });

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—è¡¨æƒ…é¢æ¿
        document.addEventListener('click', function(e) {
            if (!emojiTrigger.contains(e.target) && !emojiPanel.contains(e.target)) {
                emojiPanel.style.display = 'none';
            }
        });

        // æ¥æ”¶æ–°æ¶ˆæ¯
        socket.on('new_message', function(msg) {
            // éšè—ç©ºæç¤º
            emptyChatTip.style.display = 'none';

            // æ¸²æŸ“æ–°æ¶ˆæ¯
            renderMessage(msg);
            scrollToBottom();

            // æ ‡è®°ä¸ºå·²è¯»
            socket.emit('mark_message_read', msg.message_id);

            // å¦‚æœä¸æ˜¯å½“å‰èŠå¤©å¥½å‹ï¼Œæ˜¾ç¤ºæç¤º
            if (current_friend_id !== msg.sender_id) {
                showToast(`æ”¶åˆ°${msg.sender_nickname}çš„æ–°æ¶ˆæ¯`, 'info');
                // æ›´æ–°å¥½å‹åˆ—è¡¨æœªè¯»æç¤ºï¼ˆç®€åŒ–ä¸ºé«˜äº®ï¼‰
                const friendItem = document.querySelector(`.friend-item[data-friend-id="${msg.sender_id}"]`);
                if (friendItem) {
                    friendItem.style.backgroundColor = '#fff3cd';
                    setTimeout(() => {
                        friendItem.style.backgroundColor = '';
                    }, 5000);
                }
            }
        });

        // æ¥æ”¶æ¶ˆæ¯é€è¾¾é€šçŸ¥
        socket.on('message_delivered', function(data) {
            const messageDiv = document.querySelector(`.message[data-message-id="${data.message_id}"] .message-meta`);
            if (messageDiv) {
                const timeText = messageDiv.textContent.split(' ')[0];
                messageDiv.textContent = `${timeText} ${data.msg}`;
            }
        });

        // æ¥æ”¶æ¶ˆæ¯å·²è¯»é€šçŸ¥
        socket.on('message_read', function(data) {
            const messageDiv = document.querySelector(`.message[data-message-id="${data.message_id}"] .message-meta`);
            if (messageDiv) {
                const timeText = messageDiv.textContent.split(' ')[0];
                messageDiv.textContent = `${timeText} å·²è¯»`;
            }
            showToast(data.msg, 'info');
        });

        // æ¥æ”¶æ¶ˆæ¯é”™è¯¯
        socket.on('message_error', function(data) {
            showToast(data.msg, 'error');
        });

        // æ¥æ”¶å†å²è®°å½•é”™è¯¯
        socket.on('history_error', function(data) {
            showToast(data.msg, 'error');
            emptyChatTip.textContent = 'å†å²è®°å½•åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•';
        });

        // æ¥æ”¶çŠ¶æ€åˆ·æ–°é”™è¯¯
        socket.on('status_error', function(data) {
            showToast(data.msg, 'error');
        });

        // æ¥æ”¶æœç´¢é”™è¯¯
        socket.on('search_error', function(data) {
            showToast(data.msg, 'error');
        });

        // æ¥æ”¶è¿æ¥ç»“æœ
        socket.on('connect_success', function(data) {
            showToast(data.msg, 'success');
        });

        socket.on('connect_failed', function(data) {
            showToast(data.msg, 'error');
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        });

        // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
        function scrollToBottom() {
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
    </script>
</body>
</html>